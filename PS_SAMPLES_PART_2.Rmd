---
title: "R Notebook"
output: github_document
---

# PSO + PSA + NORMAL SKIN COMBINED ANALYSIS - PART 2

# CONTINUED

## Harmony-batch correction

## Table of content

| FIGURE NO | DESCRIPTION                                                             | LINK        |
|------------------|-------------------------------------|------------------|
| S4A       | UMAP WITH ALL SPATIAL SAMPLES (Using Harmony batch correction)          | [link](#3b) |
| 3B        | UMAP WITH ALL SPATIAL SAMPLES (Using Harmony batch correction)          | [link](#3b) |
| 3A        | NON-LESIONAL SKIN SAMPLE (ST 21 NL), and LESIONAL SKIN SAMPLE (ST 22 L) | [link](#3a) |
| S5        | Heatmap (After Harmony batch correction)                                | [link](#s5) |
| 3C        | Percentage composition                                                  | [link](#3c) |

### LOAD ALL PACKAGES

```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(ggsci)
library(ggpubr)
library(harmony)
```

```{r,eval=FALSE}
load("../all_samples_merge.RData")
```

### Running Harmony batch correction

```{r,eval=FALSE}
DefaultAssay(all_samples.merge) <- "SCT"
all_samples.hm.sct <- RunHarmony(all_samples.merge,assay.use = "SCT",project.dim = FALSE,group.by.vars = "sample.id")
```

```{r,eval=FALSE}
ElbowPlot(skin_data.hm.sct,ndims = 50)
```

```{r,eval=FALSE}
skin_data.hm.sct <- skin_data.hm.sct %>% 
    RunUMAP(reduction = "harmony", dims = 1:40) %>% 
    FindNeighbors(reduction = "harmony", dims = 1:40) %>% 
    FindClusters(resolution = 0.35) %>% 
    identity()
```

```{r}
skin_data.hm.sct <- readRDS(file="../ALL_SPATIAL_SAMPLES.RDS")
```

```{r}
## COLOR FOR LABELS
color.labels.heatmap <- c("#87CEFA",
"#4876FF",
"#CD853F",
"#BF96FF",
"#FF0000",
"#CAF178",
"#E0BFB6",
"#68228B",
"#7B0000",
"#FFC71A",
"#C355A0",
"#00B923",
"#8B5A2B",
"#838B8B",
"#005947",
"#C1CDCD",
"#FF7545")
```

```{r,fig.height=22,fig.width=15}
DefaultAssay(skin_data.hm.sct) <- "SCT"
skin_data.hm.sct.markers <- FindAllMarkers(skin_data.hm.sct, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25,assay = "SCT",) %>% filter(p_val_adj<0.05)
top10 <- skin_data.hm.sct.markers %>%
    group_by(cluster) %>%
    filter(gene %in% rownames(skin_data.hm.sct@assays$SCT@scale.data)) %>%
    top_n(n = 10, wt = avg_log2FC)

DoHeatmap(skin_data.hm.sct, features = top10$gene,assay = "SCT",group.colors = color.labels.heatmap,angle=90) + NoLegend()
```

Defining cluster labels based on marker genes

```{r}
## ADDING CLUSTER LABELS
cluster.labels <- c("0 Fibroblasts",
"1 Macs + fibroblasts",
"2 Eccrine + melanocyte precursors",
"3 Epidermis",
"4 Epidermis",
"5 Connective tissue",
"6 Mixed",
"7 Epidermis",
"8 Hair follicle and sebaceous glands",
"9 Adipose",
"10 Suprabasal keratinocytes",
"11 Smooth muscle",
"12 Endothelial cells",
"13 Immunoglobulins, fibroblasts",
"14 Smooth muscle",
"15 Mixed",
"16 Adipose, fibroblasts")

## COLOR FOR LABELS
color.labels <- c("0 Fibroblasts"="#87CEFA",
"1 Macs + fibroblasts"="#4876FF",
"2 Eccrine + melanocyte precursors"="#CD853F",
"3 Epidermis"="#BF96FF",
"4 Epidermis"="#FF0000",
"5 Connective tissue"="#CAF178",
"6 Mixed"="#E0BFB6",
"7 Epidermis"="#68228B",
"8 Hair follicle and sebaceous glands"="#7B0000",
"9 Adipose"="#FFC71A",
"10 Suprabasal keratinocytes"="#C355A0",
"11 Smooth muscle"="#00B923",
"12 Endothelial cells"="#8B5A2B",
"13 Immunoglobulins, fibroblasts"="#838B8B",
"14 Smooth muscle"="#005947",
"15 Mixed"="#C1CDCD",
"16 Adipose, fibroblasts"="#FF7545")
```

```{r}
names(cluster.labels) <- levels(skin_data.hm.sct)
skin_data.hm.sct <- RenameIdents(skin_data.hm.sct, cluster.labels)
skin_data.hm.sct <- StashIdent(skin_data.hm.sct, save.name = "Spatial.regions")
Idents(skin_data.hm.sct) <- "Spatial.regions"
```

```{r,fig.height=5,fig.width=10}
DimPlot(skin_data.hm.sct,split.by="DISEASE_STATUS",cols=color.labels,pt.size=3.5)
```

## FIGURE 3B and S4A

### UMAP WITH ALL SPATIAL SAMPLES (AFTER HARMONY BATCH CORRECTION)

<a id="3b">

```{r,fig.height=7,fig.width=10}
DimPlot(skin_data.hm.sct,cols=color.labels,pt.size=3.5)
```

</a>

## FIGURE 3A -

### NON-LESIONAL SKIN SAMPLE (ST 21 NL)

<a id="3a">

```{r}
SpatialDimPlot(skin_data.hm.sct,images = c("ST_21_NL_Batch_6"),cols=color.labels,pt.size.factor = 2.5)
```

## FIGURE 3A -

### LESIONAL SKIN SAMPLE (ST 22 L)

```{r}
SpatialDimPlot(skin_data.hm.sct,images = c("ST_22L_Batch_8"),cols=color.labels,pt.size.factor = 2.5)
```

</a>

```{r}
DefaultAssay(skin_data.hm.sct) <- "SCT"
top10 <- skin_data.hm.sct.markers %>%
    group_by(cluster) %>%
    filter(gene %in% rownames(skin_data.hm.sct@assays$SCT@scale.data)) %>%
    top_n(n = 10, wt = avg_log2FC)
```

<a id="s5">

## FIGURE SUPPLEMENTARY S5 - 

### HEATMAP showing top marker genes after Harmony batch correction

```{r,fig.height=20,fig.width=14}
DoHeatmap(skin_data.hm.sct, features = top10$gene,assay = "SCT",group.colors = color.labels,angle=90) + NoLegend()
```

</a>

### Fraction of spots per group (DISEASE STATUS)

```{r}
seurat_clusters.df.v2 <- table(skin_data.hm.sct@active.ident,skin_data.hm.sct@meta.data$DISEASE_STATUS,skin_data.hm.sct@meta.data$sample.id) %>% as.data.frame() %>%
  dplyr::rename(Cluster_id=Var1,Group=Var2,Sample_id=Var3) %>% filter(Freq!=0)  %>% group_by(Sample_id)%>% mutate(Fraction=Freq*100/sum(Freq)) %>% mutate(SUM_OF_FRACTIONS=sum(Fraction)) 
```

<a id="3c">

## FIGURE 3C -

### PERCENTAGE COMPOSITION PLOT

```{r,fig.height=20,fig.width=7}
black.bold.16.text <- element_text(face = "bold", color = "black", size = 14,angle = 90, vjust = 0.5, hjust=1)
brks <- c(0, 0.25, 0.5, 0.75, 1)

ggplot(seurat_clusters.df.v2,aes(x=Group,y=Freq,fill=Cluster_id)) + geom_bar(stat="identity",position="fill") + ggplot2::theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.x =black.bold.16.text) + scale_y_continuous(breaks = brks, labels = scales::percent(brks)) + scale_fill_manual(values = color.labels)
```

</a>

### FIGURE S7B -

### (1) UMIs per cluster<a id="s7b">

### (2) Number of genes expressed per cluster

```{r}
VlnPlot(skin_data.hm.sct,features =  "nFeature_Spatial") + scale_fill_manual(values = color.labels)

VlnPlot(skin_data.hm.sct,features =  "nCount_Spatial") + scale_fill_manual(values = color.labels)
```

</a>
