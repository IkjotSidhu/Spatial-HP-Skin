---
title: "R Notebook"
output: github_document
---

# PS SAMPLES PART 4 

## PSEUDO-BULK ANALYSIS

### *DIFFERENTIAL TESTING BETWEEN CONDITIONS - LESIONAL, NON-LESIONAL AND HEALTHY*

| FIGURE NO | DESCRIPTION                                            | LINK         |
|--------------|-----------------------------------|-------------------|
| 6A        | Hierarchical clustering based heatmap for all samples  | [link](#6a)  |
| 6B        | PCA plot for all samples - grouped by PS group         | [link](#6b)  |
| 6C        | PCA plot for all samples - grouped by Disease severity | [link](#6c)  |
| S9        | Dendogram for all samples                              | [link](#s10) |
| S10       | PCA plots - per cluster bass (PS samples only)         | [link](#s10) |

```{r}
library(DESeq2)
library(Seurat)
library(tidyverse)
```

Import the Seurat object

```{r}
skin_data.hm.sct <- readRDS(file="../ALL_SPATIAL_SAMPLES.RDS")
```

RE-NORMALIZING TO REGRESS OUT BATCH

```{r}
skin_data.hm.sct_re_normalized <- SCTransform(skin_data.hm.sct,assay = "Spatial",new.assay.name ="SCT_BATCH_REGRESSED",vars.to.regress = c("sample.id"))
```

IDENTIFY DE GENES - LESIONAL VS HEALTHY

```{r,warning=FALSE,message=FALSE}
LES_vs_HEALTHY_v1 <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Healthy skin")
LES_vs_HEALTHY_v2  <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Healthy skin")
```

```{r}
NON_LES_vs_HEALTHY <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Non-Lesional",ident.2 = "Healthy skin")
LES_VS_NON_LES <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Non-Lesional")
```

```{r}
skin_data.hm.sct_re_normalized <- NormalizeData(skin_data.hm.sct_re_normalized,assay = "Spatial")
LES_vs_HEALTHY_v3 <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Healthy skin",assay = "Spatial",test.use = "LR",latent.vars=c("Batch"))

NON_LES_vs_HEALTHY_v3 <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Non-Lesional",ident.2 = "Healthy skin",assay = "Spatial",test.use = "LR",latent.vars=c("Batch"))

LES_VS_NON_LES_v3 <- FindMarkers(skin_data.hm.sct,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Non-Lesional",assay = "Spatial",test.use = "LR",latent.vars=c("Batch"))
```

```{r}
LES_vs_HEALTHY_v4 <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Healthy skin",assay = "Spatial",test.use = "wilcox")

NON_LES_vs_HEALTHY_v4 <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Non-Lesional",ident.2 = "Healthy skin",assay = "Spatial",test.use = "wilcox")

LES_VS_NON_LES_v4 <- FindMarkers(skin_data.hm.sct,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Non-Lesional",assay = "Spatial",test.use = "wilcox")
```

```{r}
LES_vs_HEALTHY_v3_filtered <- LES_vs_HEALTHY_v3 %>% filter(p_val_adj<=0.1)
NON_LES_vs_HEALTHY_v3_filtered <- NON_LES_vs_HEALTHY_v3 %>% filter(p_val_adj<=0.1)
LES_VS_NON_LES_v3_filtered <- LES_VS_NON_LES_v3 %>% filter(p_val_adj<=0.1)

LES_vs_HEALTHY_v4_filtered <- LES_vs_HEALTHY_v4 %>% filter(p_val_adj<=0.1)
NON_LES_vs_HEALTHY_v4_filtered <- NON_LES_vs_HEALTHY_v4 %>% filter(p_val_adj<=0.1)
LES_VS_NON_LES_v4_filtered <- LES_VS_NON_LES_v4 %>% filter(p_val_adj<=0.1)
```

```{r,eval=FALSE}
write.csv(LES_vs_HEALTHY_v3_filtered,file="DE_RESULTS_LES_vs_HEALTHY_(LR_TEST).csv")
write.csv(NON_LES_vs_HEALTHY_v3_filtered,file="DE_RESULTS_NON_LES_vs_HEALTHY_(LR_TEST).csv")
write.csv(LES_VS_NON_LES_v3_filtered,file="DE_RESULTS_LES_VS_NON_LES_(LR_TEST).csv")

write.csv(LES_vs_HEALTHY_v4_filtered,file="DE_RESULTS_LES_vs_HEALTHY_(WILCOX_TEST).csv")
write.csv(NON_LES_vs_HEALTHY_v4_filtered,file="DE_RESULTS_NON_LES_vs_HEALTHY_(WILCOX_TEST).csv")
write.csv(LES_VS_NON_LES_v4_filtered,file="DE_RESULTS_LES_VS_NON_LES_(WILCOX_TEST).csv")
```

```{r}
LES_vs_HEALTHY_v4 <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Healthy skin",assay = "Spatial",test.use = "LR",latent.vars=c("sample.id"))
NON_LES_vs_HEALTHY_v4 <- FindMarkers(skin_data.hm.sct_re_normalized,group.by = "DISEASE_STATUS",ident.1 = "Non-Lesional",ident.2 = "Healthy skin",assay = "Spatial",test.use = "LR",latent.vars=c("sample.id"))
LES_VS_NON_LES_v4 <- FindMarkers(skin_data.hm.sct,group.by = "DISEASE_STATUS",ident.1 = "Lesional",ident.2 = "Non-Lesional",assay = "Spatial",test.use = "LR",latent.vars=c("sample.id"))
```

```{r}
LES_vs_HEALTHY_v4_filtered <- LES_vs_HEALTHY_v4 %>% filter(p_val_adj<=0.1)
NON_LES_vs_HEALTHY_v4_filtered <- NON_LES_vs_HEALTHY_v4 %>% filter(p_val_adj<=0.1)
LES_VS_NON_LES_v4_filtered <- LES_VS_NON_LES_v4 %>% filter(p_val_adj<=0.1)
```

```{r,eval=FALSE}
write.csv(LES_vs_HEALTHY_v4_filtered,file="DE_RESULTS_LES_vs_HEALTHY_(LR_TEST)(SAMPLE_VAR).csv")
write.csv(NON_LES_vs_HEALTHY_v4_filtered,file="DE_RESULTS_NON_LES_vs_HEALTHY_(LR_TEST)(SAMPLE_VAR).csv")
write.csv(LES_VS_NON_LES_v4_filtered,file="DE_RESULTS_LES_VS_NON_LES_(LR_TEST)(SAMPLE_VAR).csv")
```

## PSEUDO-BULK APPROACH

Import Pseudo-counts from the Seurat object

```{r}
pseudo.counts <- Seurat:::PseudobulkExpression(object = skin_data.hm.sct,assays = "Spatial",group.by = "sample.id",slot = "counts",pb.method = "aggregate") 

summary(colSums(pseudo.counts$Spatial))
```

```{r}
colSums(pseudo.counts$Spatial>10)
```

```{r}
pseudo.counts.df <- as.data.frame(pseudo.counts$Spatial) %>% rownames_to_column("Gene")

Genes <- pseudo.counts.df$Gene

library(DESeq2)

groups.table <- read.csv(file="PSEUDO-BULK-DATA/groups.table.csv",stringsAsFactors = TRUE) %>% filter(Sample.ID!="") %>% column_to_rownames("Sample.ID") %>% unite("DISEASE_and_SEVERITY","GROUP_I","SEVERITY", sep = "_", remove = FALSE, na.rm = FALSE)

```

```{r}
coldata <- groups.table[,c("DISEASE_and_SEVERITY","GROUP_I","SEVERITY","BATCH")]
```

```{r}
# Ordering the file
counts.file <- pseudo.counts.df[,rownames(groups.table)]
#counts.file <- mutate_all(counts.file, function(x) as.numeric(as.character(x)))

group.name <- colnames(groups.table)[1]
groups.levels <- factor(groups.table[,group.name]) %>% levels()
```

```{r}
rownames(counts.file) <- Genes
counts.final <- counts.file
```

```{r,,warning=FALSE,message=FALSE}
# Run DE here
dds <- DESeqDataSetFromMatrix(countData = counts.final,colData=groups.table,design = ~BATCH + GROUP_I)
dds <- DESeq(dds,quiet = TRUE)
```

```{r}
normalized.counts <- counts(dds, normalized=TRUE)
colSums(normalized.counts)
```

```{r}
vsd <- vst(dds, blind=TRUE)
```

### FIGURE 6B / 6C <a id="6b"></a><a id="6c"></a>

PCA plots showing clustering of samples based on disease group and severity / PASI score.

```{r}
plotPCA(vsd, intgroup=c("GROUP_I","GROUP_II"))+ scale_color_manual(values=c("dimgray","#cc3333","#ffcc33","#ff9999","#ff9933"))

pcaData <- plotPCA(vsd, intgroup=c("SEVERITY","PASI_SCORE","DISEASE_and_SEVERITY"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))

#pdf("ALL_SAMPLES_PCA_PLOT.pdf",height = 8,width = 10)
ggplot(pcaData, aes(PC1, PC2, fill=PASI_SCORE, shape=DISEASE_and_SEVERITY)) +
  geom_point(size=3) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  coord_fixed() +
  scale_shape_manual(values=c(21,22,23,24,25))
#dev.off()
```

```{r}
sampleDists <- dist(t(assay(vsd)))
```

### FIGURE 6A <a id="6a"></a>

### Samples cluster by disease severity not systemic co-morbidity

```{r}
library("RColorBrewer")
library("pheatmap")
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$GROUP_I, vsd$SEVERITY,vsd$GROUP_II, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette(brewer.pal(9, "RdYlBu")) (255)
#pdf("HC_WITH_HEATMAP.pdf",height = 15,width = 15)
print(pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors))
#dev.off()
```

### FIGURE S9 <a id="s9"></a>

## DENDOGRAM

```{r,fig.height=4}
hc <- hclust(sampleDists)

print(plot(hc, labels=paste(vsd$GROUP_I,vsd$SEVERITY,vsd$GROUP_II,sep = ":")))

```

## DENDOGRAMS - EXCLUDED HEALTHY SAMPLES

```{r}
vsd_subset <- vsd[,vsd$GROUP_I %in% c("Non-Lesional","Lesional")]
sampleDists <- dist(t(assay(vsd_subset)))

hc <- hclust(sampleDists)

#pdf("DENDOGRAM_PS_ONLY.pdf",height = 10,width = 10)
print(plot(hc, labels=paste(vsd_subset$GROUP_I,vsd_subset$SEVERITY,vsd_subset$PASI_SCORE,sep = ":")))
#dev.off()

  ## PCA PLOT
#pdf(file="PCA_PS_ONLY.pdf",height = 8,width = 10)
plotPCA(vsd_subset, intgroup=c("GROUP_I", "SEVERITY")) + geom_text(label = vsd_subset$PASI_SCORE,nudge_x = 2, nudge_y = 2) + scale_color_manual(values=c("#ff9999","#cc3333","#ffcc33","#ff9933"))
#dev.off()

  ## PCA PLOT
#pdf(file="PCA_ALL_SAMPLES.pdf",height = 8,width = 10)
plotPCA(vsd, intgroup=c("GROUP_I", "GROUP_II")) + geom_text(label = vsd$PASI_SCORE,nudge_x = 2, nudge_y = 2) + scale_color_manual(values=c("dimgray","#cc3333","#ffcc33","#ff9999","#ff9933"))
#dev.off()
```

```{r}
sampleDists <- dist(t(assay(vsd)))

hc <- hclust(sampleDists)

#pdf("DENDOGRAM_ALL_SAMPLES.pdf",height = 10,width = 10)
print(plot(hc, labels=paste(vsd$GROUP_I,vsd$SEVERITY,vsd$GROUP_II,vsd$PASI_SCORE,sep = ":")))
#dev.off()


sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$GROUP_I, vsd$SEVERITY,vsd$GROUP_II,vsd$PASI_SCORE, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
#pdf("HC_ALL_SAMPLES_HEATMAP.pdf",height = 15,width = 15)
print(pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors))
#dev.off()
```

```{r}
res.1<- results(dds,contrast=c('GROUP_I','Lesional','Healthy Skin')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
res.2<- results(dds,contrast=c('GROUP_I','Lesional','Non-Lesional')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
res.3<- results(dds,contrast=c('GROUP_I','Non-Lesional','Healthy Skin')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
```

```{r}
res.1<- results(dds_2,contrast=c('GROUP_I','Lesional','Healthy Skin')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
res.2<- results(dds_2,contrast=c('GROUP_I','Lesional','Non-Lesional')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
res.3<- results(dds_2,contrast=c('GROUP_I','Non-Lesional','Healthy Skin')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
```

```{r}
dds$group <- factor(paste0(dds$GROUP_I, dds$SEVERITY))
design(dds) <- ~ group

dds <- DESeq(dds) 
```

```{r}
res.1_v2<- results(dds,contrast=c('group','LesionalModerate-severe','Healthy SkinHealthy')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
res.2_v2<- results(dds,contrast=c('group','LesionalMild','Healthy SkinHealthy')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
#res.2<- results(dds,contrast=c('GROUP_I','Lesional','Non-Lesional')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
#res.3<- results(dds,contrast=c('GROUP_I','Non-Lesional','Healthy Skin')) %>% as.data.frame() %>% rownames_to_column("Gene") %>% dplyr::filter(padj<0.1)
```

```{r,eval=FALSE}
Group.data <- table(skin_data.hm.sct@meta.data$DISEASE_STATUS,skin_data.hm.sct@meta.data$Spatial.regions) %>% as.data.frame()  
colnames(Group.data) <- c("Group","Cluster","Frquency")
write.csv(Group.data,"CLUSTER_FREQUENCY_BY_GROUP.csv")
```

```{r}
cluster.labels <- unique(skin_data.hm.sct@meta.data$Spatial.regions) %>% as.vector() %>% sort(decreasing = TRUE)
```

```{r}
cluster.labels.filtered <- c("9 Adipose","10 Suprabasal keratinocytes","11 Smooth muscle","12 Endothelial cells","13 Immunoglobulins, fibroblasts","14 Smooth muscle","15 Mixed","16 Adipose, fibroblasts")
```

### Figure S9 <a id="s9"></a>

### CLUSTER SPECIFIC (PSEUDO-BULK) PCA-plots

#### PART 1

```{r,warning=FALSE,message=FALSE,fig.height = 5,fig.width = 5}
for(x in cluster.labels){
  subset.data <- subset(skin_data.hm.sct,Spatial.regions %in% c(x))
  dds <- pseudo_bulk_out(subset.data,group_label = "sample.id",groups_tbl_path = "PSEUDO-BULK-DATA/groups.table.csv")
  if(!is.null(dds)){
    tryCatch({
      vsd <- vst(dds, blind=TRUE)
      
      # ALL PSORIASIS SAMPLES
      vsd_subset <- vsd[,vsd$GROUP_I %in% c("Lesional","Non-Lesional")]
      
        ## PCA PLOT
      #pdf(file=paste("PSEUDO_BULK_OUTPUT/ALL_PS_SAMPLES/",x,"_PCA_PLOT_PSEUDOBULK_ALL_SAMPLES.pdf"),height = 8,width = 10)
      print(plotPCA(vsd_subset, intgroup=c("GROUP_I", "SEVERITY"))+ ggtitle(paste("PCA Plot for -",x))+ scale_color_manual(values=c("#ff9999","#cc3333","#ffcc33","#ff9933")))
      #dev.off()
      
  }, error=function(e){ skip_to_next <<- TRUE})
  }
  
}
```

#### PART-2

```{r,warning=FALSE,message=FALSE,fig.height = 5,fig.width = 5}
#cluster.ids <- skin_data.hm.sct@meta.data$Spatial.regions %>% unique() %>% as.vector()
for(x in cluster.labels.filtered){
  subset.data <- subset(skin_data.hm.sct,Spatial.regions %in% c(x))
  dds <- pseudo_bulk_out(subset.data,group_label = "sample.id",groups_tbl_path = "PSEUDO-BULK-DATA/groups.table.csv")
  if(!is.null(dds)){
    tryCatch({
      vsd <- vst(dds, blind=TRUE,nsub = 100)
      normalized.counts <- counts(dds, normalized=TRUE)
      
      # ONLY PSORIASIS SAMPLES
      vsd_subset <- vsd[,vsd$GROUP_I %in% c("Lesional","Non-Lesional")]
      ## PCA PLOT
      #pdf(file=paste("PSEUDO_BULK_OUTPUT/ALL_SAMPLES(VERSION_2)/",x,"_PCA_PLOT_PSEUDOBULK_ALL_SAMPLES.pdf"),height = 8,width = 10)
      print(plotPCA(vsd_subset, intgroup=c("GROUP_I", "SEVERITY"))+ ggtitle(paste("PCA Plot for -",x))+ scale_color_manual(values=c("#ff9999","#cc3333","#ffcc33","#ff9933"))) 
      #dev.off()
      
  }, error=function(e){ skip_to_next <<- TRUE})
  }
  
}
```

### FIGURE 8A <a id="8a"></a>

```{r,warning=FALSE,message=FALSE,fig.height = 5,fig.width = 5}
subset.data <- subset(skin_data.hm.sct,Spatial.regions %in% c("1 Macs + fibroblasts"))

dds <- pseudo_bulk_out(subset.data,group_label = "sample.id",groups_tbl_path = "PSEUDO-BULK-DATA/groups.table.csv")

vsd <- vst(dds, blind=TRUE,nsub = 100)

# ALL PSORIASIS SAMPLES
vsd_subset_2 <- vsd[,vsd$GROUP_I %in% c("Lesional","Non-Lesional")]
#pdf(file=paste("PSEUDO_BULK_OUTPUT/ALL_PS_SAMPLES/","1 Macs + fibroblasts","_PCA_PLOT_PSEUDOBULK_ALL_SAMPLES(WITH_LABELS)(V2).pdf"),height = 8,width = 10)
plotPCA(vsd_subset_2, intgroup=c("GROUP_I", "SEVERITY")) + geom_text(label = vsd_subset_2$PASI_SCORE,nudge_x = 0.50, nudge_y = 1) + scale_color_manual(values=c("#ff9999","#cc3333","#ffcc33","#ff9933"))
#dev.off()

#12 Endothelial cells
subset.data <- subset(skin_data.hm.sct,Spatial.regions %in% c("12 Endothelial cells"))
dds <- pseudo_bulk_out(subset.data,group_label = "sample.id",groups_tbl_path = "PSEUDO-BULK-DATA/groups.table.csv")
vsd <- vst(dds, blind=TRUE,nsub = 100)

# ALL PSORIASIS SAMPLES
vsd_subset_2 <- vsd[,vsd$GROUP_I %in% c("Lesional","Non-Lesional")]
#pdf(file=paste("PSEUDO_BULK_OUTPUT/ALL_PS_SAMPLES/","12 Endothelial cells","_PCA_PLOT_PSEUDOBULK_ALL_SAMPLES(WITH_LABELS)(V2).pdf"),height = 8,width = 10)
plotPCA(vsd_subset_2, intgroup=c("GROUP_I", "SEVERITY")) + geom_text(label = vsd_subset_2$PASI_SCORE,nudge_x = 0.50, nudge_y = 1)  + scale_color_manual(values=c("#ff9999","#cc3333","#ffcc33","#ff9933"))
#dev.off()
```
