---
title: "R Notebook"
output: html_notebook
---
## R Notebook covering data generated from healthy samples for Figure 1, Supplementary figure 1 and 2.
## LOAD ALL PACKAGES
```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(RColorBrewer)
library(pheatmap)
library(scales)
```
# Import functions from the custom R script
```{r}
source("SPATIAL_FUNCTIONS.R")
```

# IMPORTING THE HEATLTHY SAMPLES
```{r}
## HEALTHY SAMPLES
## HEALTHY MALE SKIN 1 & 2
HEALTHY.Male.s1 <- Load10X_Spatial(data.dir ="../../FOURTH_RUN/SAMPLE A1/",slice="ST-HM-1-R1")
HEALTHY.Male.s2 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HM-1/",slice="ST-HM-1-R2")

## HEALTHY FEMALE SKIN 1 & 2 (FROM THE SAME DONOR)
HEALTHY.Female1.s1 <- Load10X_Spatial(data.dir ="../../FOURTH_RUN/SAMPLE B1/",slice="ST-HF-1-R1")
HEALTHY.Female1.s2 <- Load10X_Spatial(data.dir ="../../FIFTH_RUN/SAMPLE D1/",slice="ST-HF-1-R2")
HEALTHY.Female1.s3 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HF-1/",slice="ST-HF-1-R3")

## HEALTHY FEMALE
HEALTHY.Female2.s1 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HF-2E/",slice="ST-HF-2-R1")
HEALTHY.Female2.s2 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HF-2F/",slice="ST-HF-2-R2")

```

### Import the spots to be removed from loupe browser.
```{r}
# HEALTHY FEMALE SKIN 2
#REMOVE SPOTS

remove.spots <- read.csv(file="../CLOUPE_FILES/FIFTH_RUN/D1/OUTLIERS.csv")
subset_spots <- Cells(HEALTHY.Female1.s2)[which((!(rownames(HEALTHY.Female1.s2@meta.data) %in% remove.spots$Barcode)))]
HEALTHY.Female1.s2.clean <- subset(HEALTHY.Female1.s2,cells=subset_spots)
```

#SAMPLE IDS
```{r}

HEALTHY.Male.s1$sample.id<- "HV1_S1_R1" 
HEALTHY.Male.s2$sample.id<- "HV1_S1_R2"

HEALTHY.Female1.s1$sample.id <- "HV2_S1_R1"
HEALTHY.Female1.s2.clean$sample.id <- "HV2_S1_R2"
HEALTHY.Female1.s3$sample.id <- "HV2_S2"

HEALTHY.Female2.s1$sample.id <- "HV3_S1"
HEALTHY.Female2.s2$sample.id <- "HV3_S2"
```

# SAMPLE IDS (version 2) - (Full name + Biopsy site)
# TRUNK and FA (Forearm)
```{r}
HEALTHY.Male.s1$orig.ident <- "Healthy Volunteer 1 - TRUNK R1" 
HEALTHY.Male.s2$orig.ident <-"Healthy Volunteer 1 - TRUNK R2"

HEALTHY.Female1.s1$orig.ident <- "Healthy Volunteer 2 - FA R1"
HEALTHY.Female1.s2.clean$orig.ident <- "Healthy Volunteer 2 - FA R2"
HEALTHY.Female1.s3$orig.ident <- "Healthy Volunteer 2 - TRUNK"

HEALTHY.Female2.s1$orig.ident <- "Healthy Volunteer 3 - FA R1"
HEALTHY.Female2.s2$orig.ident <- "Healthy Volunteer 3 - TRUNK"
```


# Compile the samples into one list.
```{r}
Healthy_Samples <- c(HEALTHY.Male.s1,HEALTHY.Male.s2,HEALTHY.Female1.s1,HEALTHY.Female1.s2.clean,HEALTHY.Female1.s3,HEALTHY.Female2.s1,HEALTHY.Female2.s2)
```

# Generating spatial plots without QC filtering
```{r}
for (x in Healthy_Samples){
  st_plot(x)
}
```

# QC plots for healthy samples
```{r}
for (x in Healthy_Samples){
  st_plot_QC(x)
}
```

# QC scatter plots
```{r}
for (x in Healthy_Samples){
  st_scatter_QC(x)
}
```

# Filtering all samples to remove spots with less than 200 genes expressed
```{r}
i <- 1
while(i <= length(Healthy_Samples)){
  filtered_data <- st_filter_by_genes(st.data = Healthy_Samples[[i]],x = 200)
  Healthy_Samples[[i]] <- filtered_data
  i <- i+1
}
```

# Batch correction of all samples using Seurat Anchor integeration
```{r}
new.skin.combined <- st_combine(Healthy_Samples,ndim = 20,res = 0.6)
```

# ADDING ADDITIONAL META-DATA
```{r,eval=FALSE}
meta.data_skin <- new.skin.combined@meta.data$orig.ident %>% as.data.frame()
write.csv(meta.data_skin,file="HEALTHY_SAMPLES_ST_META_DATA.csv")
```

# IMPORTING ST META-DATA UPDATED VERSION
```{r,eval=FALSE}
meta.data_skin_updated <- read.csv(file="HEALTHY_SAMPLES_ST_META_DATA.csv")
```

# ADDING META-DATA to Seurat object
```{r,eval=FALSE}
new.skin.combined@meta.data$orig.ident <- meta.data_skin_updated$orig.ident
new.skin.combined@meta.data$sample.id <- meta.data_skin_updated$sample.id
```

# Determining marker genes for batch corrected healthy samples + heatmap
```{r}
new.skin.combined.markers <- FindAllMarkers(new.skin.combined, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25,assay = "SCT")
DefaultAssay(new.skin.combined) <- "SCT"
top10 <- new.skin.combined.markers %>%
    group_by(cluster) %>%
    filter(p_val_adj<0.05) %>%
    top_n(n = 10, wt = avg_log2FC) %>%
    filter(gene %in% VariableFeatures(new.skin.combined_V2))
pdf(width = 20,height=15,file = "HEATMAP_HEALTHY_SAMPLES_CLUSTERS_ONLY.pdf")
print(DoHeatmap(new.skin.combined, features = top10$gene,assay = "SCT",group.colors = custom_colors) + NoLegend())
dev.off()
```

# Assign cluster ids 
```{r}
new.cluster.ids <- c("0 Mixed","1 Dermis",
"2 Dermis Adipose","3 Epidermis 1","4 Dermis Connective Tissue","5 Upper follicle (UF) and Perifollicular dermis","6 Epidermis 2","7 Dermis 2","8 Dermis Smooth Muscle","9 Hair follicle","10 Dermis Lymphatics","11 Dermis vasculature")
names(new.cluster.ids) <- levels(new.skin.combined)
new.skin.combined <- RenameIdents(new.skin.combined, new.cluster.ids)
new.skin.combined <- StashIdent(new.skin.combined, save.name = "Spatial.regions")
```

# Defining and viewing color scheme for UMAP and spatial plot
```{r}
custom_colors <- c("#B4DFFC","#6EAB3D","#FFD700","#A020F0","#FFA500","#AEDD3C","#595959","#D2AF81FF","#3A49FC","#FF0000","#A86F3D","#A18FAA")
show_col(custom_colors)
```

# General UMAP with defined color scheme
```{r}
pdf(width = 12,height=8,file = "UMAP_HEALTHY_SAMPLES_CLUSTERS_ONLY.pdf")
DimPlot(new.skin.combined,cols = custom_colors,pt.size = 3.5)
dev.off()

# FOR IN NOTEBOOK VIEW
DimPlot(new.skin.combined,cols = custom_colors,pt.size = 3.5)
```

# UMAP plot split by samples
```{r}
DimPlot(new.skin.combined,split.by = "sample.id")
```

```{r}
## SAVE THE RESULTS
save(new.skin.combined,file = "HEALTHY_SKIN_SAMPLES_ST.RData")
```

# Spatial plot for HV2_S2_R1 /HEALTHY_FEMALE_SAMPLE_1
# SAVE OUTPUT TO PDF
```{r}
pdf(width = 8,height=10,file = "HEALTHY_FEMALE_SAMPLE_1_R2_SPATIAL_PLOT.pdf")
SpatialDimPlot(new.skin.combined,images="HealthyFemale.1.S2",cols = custom_colors,pt.size.factor = 2.4)
dev.off()
```

# VIEW SPATIAL PLOT HERE
```{r}
SpatialDimPlot(new.skin.combined,images="HealthyFemale.1.S2",cols = custom_colors,pt.size.factor = 2.4)
```

# Generate Spatial plot for all samples
```{r}
images <- Images(new.skin.combined) %>% as.vector()
for(x in images){
  pdf(width = 8,height=10,file = paste(x,"_SPATIAL_PLOT.pdf"))
  print(SpatialDimPlot(new.skin.combined,images=x,cols = custom_colors,pt.size.factor = 2))
  dev.off()
}
```

# Color scheme for MIA heatmap
```{r}
col.pal <- RColorBrewer::brewer.pal(9, "OrRd")
```

## MIA - scRNA dataset (Travis et al)
## SINGLE CELL DATA FROM TRAVIS PAPER
```{r}
load("../../TRAVIS_scRNA_DATA/SkinSeuratTotal.Rdata")
```

```{r}
# META DATA FROM TRAVIS 
meta.data <- read.csv("../../TRAVIS_scRNA_DATA/Cell_Level_Metadata.csv")
```

```{r}
#AddMetaData(SkinSeuratTotal,metadata = meta.data$Specific_CellType,col.name = "Specific_Celltype")
skin.meta.data <- as.data.frame(SkinSeuratTotal@meta.data) %>% rownames_to_column("CellID")
inner_join(x=skin.meta.data,y=meta.data,by="CellID")
```
```{r}
SkinSeuratTotal@meta.data <- inner_join(x=skin.meta.data,y=meta.data,by="CellID") %>% column_to_rownames("CellID")
```


```{r,eval=FALSE}
SkinSeuratTotal@meta.data$Celltype <- meta.data$CellType
SkinSeuratTotal@meta.data$Condition <- meta.data$Condition
SkinSeuratTotal@meta.data$Celltype_specific <- meta.data$Specific
SkinSeuratTotal@meta.data$SampleID <- meta.data$SampleCondition
```

```{r}
#SUBSET DATA TO ONLY HEALTHY SAMPLES
travis_NM_skin_scRNA<- subset(SkinSeuratTotal,subset = Condition == c("Normal"))
```


```{r}
## PROCESS SC RNA DATA
travis_NM_skin_scRNA <- NormalizeData(travis_NM_skin_scRNA)
travis_NM_skin_scRNA <- FindVariableFeatures(travis_NM_skin_scRNA, selection.method = "vst", nfeatures = 2000)
travis_NM_skin_scRNA <- ScaleData(travis_NM_skin_scRNA)
travis_NM_skin_scRNA <- RunPCA(travis_NM_skin_scRNA, features = VariableFeatures(object = travis_NM_skin_scRNA))
travis_NM_skin_scRNA <- FindNeighbors(travis_NM_skin_scRNA, dims = 1:40)
travis_NM_skin_scRNA <- FindClusters(travis_NM_skin_scRNA, resolution = 1)
travis_NM_skin_scRNA <- RunUMAP(travis_NM_skin_scRNA, dims = 1:40)
```
## Normal skin - scRNA data from Travis paper 
```{r}
Idents(travis_NM_skin_scRNA) <- "Specific_CellType"
DimPlot(travis_NM_skin_scRNA,pt.size = 2.5,label = TRUE)

Idents(travis_NM_skin_scRNA) <- "CellType"
DimPlot(travis_NM_skin_scRNA,pt.size = 2.5)
```

```{r}
save(travis_NM_skin_scRNA,file = "../../TRAVIS_scRNA_DATA/travis_NM_skin_scRNA.RDS")
```

```{r}
single_cell.markers <- FindAllMarkers(travis_NM_skin_scRNA,assay = "RNA",logfc.threshold = 0.25)
```

```{r}
filtered_single_cell.markers <- single_cell.markers %>% filter(p_val_adj<=0.05) %>% group_by(cluster) %>% top_n(n =300,wt = avg_log2FC) %>% filter(avg_log2FC>0.25)
filtered_spatial_markers <- new.skin.combined.markers %>% filter(p_val_adj<=0.05) %>% group_by(cluster) %>% top_n(n =300,wt = avg_log2FC) %>% filter(avg_log2FC>0.25)
```

# Figure - 2B
```{r}
##INTERSECT GENES BETWEEN scRNA and Spatial data
st.genes <- unique(rownames(new.skin.combined@assays$Spatial@counts))
sc.genes <- unique(rownames(travis_NM_skin_scRNA@assays$RNA@counts))
all.genes.scrna_and_spt <- unique(intersect(sc.genes,st.genes))
```
```{r}
MIA_results <- MIA(total_genes = length(all.genes.scrna_and_spt),single_cell.markers = filtered_single_cell.markers,spatial.markers = filtered_spatial_markers)

E.data <- MIA_results %>% column_to_rownames("cluster")
E.data <- E.data[,order(colnames(E.data))]
pheatmap(E.data,cluster_cols = FALSE,cluster_rows = FALSE,fontsize=15,color = col.pal)
```

```{r}
immune_only.E.data <- E.data[,c("T cell-1","T cell-2","T cell-3","Myeloid-1","Langerhans","Mast-1","Mast-2")]
pdf(file = "MIA_regions_IMMUNE_CELLS.pdf",width = 10,height = 4)
pheatmap(immune_only.E.data,cluster_cols = FALSE,cluster_rows = FALSE,fontsize=15,color = col.pal)
dev.off()
```
```{r}
structure_only.E_data <- E.data[,c("Fibroblast-1","Fibroblast-2","Fibroblast-4","Fibroblast-5","HairFollicle","Keratinocyte-2","Keratinocyte-3","Keratinocyte-5","Keratinocyte-6","Keratinocyte-8","Sebocyte","Venule-1","Venule-2","Venule-3","Venule-4","VSMC-1")]
pdf(file = "MIA_regions_STRUCTURAL_CELLS.pdf",width = 10,height = 4)
pheatmap(structure_only.E_data,cluster_cols = FALSE,cluster_rows = FALSE,fontsize=15,color = col.pal)
dev.off()
```

## NOW CALCULATING ENRICHMENT USING NEW DATASET (Travis et al)
# Seurat based cell type enrichment
```{r,eval=FALSE}
# RUN THIS ON BIG PURPLE 
skin_reference.2 <- SCTransform(travis_travis_NM_skin_scRNA, ncells = 3000, verbose = FALSE) %>% RunPCA(verbose = FALSE) %>% 
    RunUMAP(dims = 1:40)
anchors <- FindTransferAnchors(reference = skin_reference.2, query = new.skin.combined, normalization.method = "SCT")
predictions.assay <- TransferData(anchorset = anchors, refdata = skin_reference.2$Specific_CellType, prediction.assay = TRUE, 
    weight.reduction = new.skin.combined[["pca"]],dims = 1:40)
new.skin.combined[["predictions_travis_data"]] <- predictions.assay
```


## CELL TYPES FOR FIGURE 1 - Travis et al. single cell dataset (Only using the healthy subset of scRNA data)
```{r}
Cell_types <- c("Fibroblast-1","HairFollicle","Keratinocyte-5","Keratinocyte-3","Sebocyte","VSMC-1","Melanocyte")
DefaultAssay(new.skin.combined) <- "predictions_travis_data"
for (x in Cell_types){
  pdf(file = paste("HEALTHY_FEMALE_1_R2_CELL_TYPE_",x,".pdf"),width = 10,height = 15)
  print(SpatialFeaturePlot(new.skin.combined, features = c(x), pt.size.factor = 2.5, ncol = 2, crop = TRUE,images = "HealthyFemale.1.S2") + scale_fill_gradientn(colors=cols,limits = c(0,1))) 
  dev.off()
}
```




## PERCENTAGE PLOT FOR DIFFERENT SPATIAL REGIONS
# Calculated on a per sample basis
```{r}
Regions.df <- table(new.skin.combined@meta.data$Spatial.regions,new.skin.combined@meta.data$orig.ident) %>% as.data.frame() %>% dplyr::rename(Spatial_Region=Var1,Sample=Var2) 

black.bold.16.text <- element_text(face = "bold", color = "black", size = 14,angle = 90, vjust = 0.5, hjust=1)
brks <- c(0, 0.25, 0.5, 0.75, 1)

pdf(file="PERCENTAGE_COMPOSTION_PLOT_HEALTHY_SAMPLES.pdf",height = 14,width = 8)
ggplot(Regions.df,aes(x=Sample,y=Freq,fill=Spatial_Region)) + geom_bar(stat="identity",position="fill") + scale_fill_manual(values =custom_colors)  + ggplot2::theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.x =black.bold.16.text) + scale_y_continuous(breaks = brks, labels = scales::percent(brks)) + ylab("% Composition of Sample by Spatial Region / Clusters")
dev.off()
```


## LOAD DATA FROM HANNIFA PAPER
```{r}
load("../../scRNA_DATA/HEALTHY_SC_RNA_PROCESSED.RData")
```

```{r}
DimPlot(healthy_skin.sc_data,raster = FALSE)
```

```{r}
Idents(healthy_skin.sc_data) <- "final_clustering"
hnf_skin_scRNA.markers <- FindAllMarkers(healthy_skin.sc_data,assay = "RNA",logfc.threshold = 0.25,max.cells.per.ident=400,only.pos = TRUE)
```
```{r}
cell.counts <- as.data.frame(table(travis_NM_skin_scRNA@meta.data$Specific_CellType))
write.csv(cell.counts,file="../../TRAVIS_scRNA_DATA/CELL_COUNTS_TRAVIS_HEALTHY_SKIN_DATA.csv")
```

```{r}
filtered_cell.counts <- cell.counts %>% filter(Freq>50) 
Idents(travis_NM_skin_scRNA) <- "Specific_CellType"
travis_healthy_data.subset <- subset(x = travis_NM_skin_scRNA, idents = c(filtered_cell.counts$Var1))

DimPlot(travis_healthy_data.subset,pt.size = 2.5)
```
```{r}
pdf(width = 12,height=8,file = "UMAP_TRAVIS_DATA_HEALTHY_SAMPLES_ONLY.pdf")
DimPlot(travis_healthy_data.subset,pt.size = 3.5)
dev.off()
```

## PATHWAY ANALYSIS FOR SPATIAL DATA
```{r}
for(i in seq(0,11)){
  cluster <- new.skin.combined.markers %>% filter(cluster==i)
  #GO_PATHWAYS_ENRICH(cluster,ONT="BP",OUTPUT = i)
  #GO_PATHWAYS_ENRICH(cluster,ONT="CC",OUTPUT = i)
  #GO_PATHWAYS_ENRICH(cluster,ONT="MF",OUTPUT = i)
  KEGG_PATHWAYS(cluster,OUTPUT = i)
}
```

```{r}
cluster.5 <- filtered_spatial_markers %>% filter(cluster==5)
Myeloid.1 <- filtered_single_cell.markers %>% filter(cluster=="Myeloid-1")

length(intersect(cluster.5$gene,Myeloid.1$gene))

cluster.6 <- filtered_spatial_markers %>% filter(cluster==6)
Keratinocyte.5 <- filtered_single_cell.markers %>% filter(cluster=="Keratinocyte-5")

length(intersect(cluster.6$gene,Keratinocyte.5$gene))
```

#
## MIA FOR HANNIFA PAPER
```{r}
hnf_skin_scRNA.markers <- read.csv("../../scRNA_DATA/HANNIFA_MARKERS.csv") %>% filter(p_val_adj<=0.05) %>% group_by(cluster) %>% top_n(n =300,wt = avg_log2FC) %>% filter(avg_log2FC>0.25)
```

```{r}

hnf_data_counts <- as.data.frame(table(healthy_skin.sc_data@meta.data$final_clustering))
write.csv(hnf_data_counts,file="HEALTHY_SAMPLES_HANNIFA_DATA_COUNTS.csv")
```

```{r}
##INTERSECT GENES BETWEEN scRNA and Spatial data
st.genes <- unique(rownames(new.skin.combined@assays$Spatial@counts))
sc.genes <- unique(rownames(healthy_skin.sc_data@assays$RNA@counts))
all.genes.scrna_and_spt <- unique(intersect(sc.genes,st.genes))
```

```{r}
MIA_results_PART_2 <- MIA(total_genes = length(all.genes.scrna_and_spt),single_cell.markers = hnf_skin_scRNA.markers,spatial.markers = filtered_spatial_markers)

E.data_PART_2 <- MIA_results_PART_2 %>% column_to_rownames("cluster")
E.data_PART_2 <- E.data_PART_2[,order(colnames(E.data_PART_2))]
is.na(E.data_PART_2) <- do.call(cbind,lapply(E.data_PART_2, is.infinite))
pheatmap(E.data_PART_2,cluster_cols = FALSE,cluster_rows = FALSE,fontsize=15,color = col.pal)
```

```{r}
## IMMUNE CELLS
immune_only.E.data_PART_2 <- E.data_PART_2[,c("DC1","DC2","Macro_1","Macro_2","moDC_1","moDC_2","moDC_3","MigDC","Mono","Inf_mono","ILC1_NK","ILC1_3","ILC2","Tc","Th","Treg","Mast_cell","Plasma","NK")]
pdf(file = "MIA_regions_(HANNIFA_PAPER)_IMMUNE_CELLS.pdf",width = 10,height = 5)
print(pheatmap(immune_only.E.data_PART_2,cluster_cols = FALSE,cluster_rows = FALSE,fontsize=15,color = col.pal))
dev.off()
```
```{r}
non_immune_only.E.data_PART_2 <- E.data_PART_2 %>% dplyr::select(-c("DC1","DC2","Macro_1","Macro_2","moDC_1","moDC_2","moDC_3","MigDC","Mono","Inf_mono","ILC1_NK","ILC1_3","ILC2","Tc","Th","Treg","Mast_cell","Plasma","NK","nan"))
pdf(file = "MIA_regions_(HANNIFA_PAPER)_NON_IMMUNE_CELLS.pdf",width = 10,height = 5)
print(pheatmap(non_immune_only.E.data_PART_2,cluster_cols = FALSE,cluster_rows = FALSE,fontsize=15,color = col.pal))
dev.off()
```

```{r}
pdf(file = "UMAP_ONLY_HEALTHY_SAMPLES_(HANNIFA_PAPER).pdf",width = 16,height=8)
print(DimPlot(healthy_skin.sc_data_subset,pt.size = 1.2,shuffle = TRUE,raster=FALSE))
dev.off()
```

```{r}
#VIOLIN PLOT FOR UMIs and SEURAT CLUSTERS
pdf(file = "VIOLIN_PLOT_UMIs_and_CLUSTERS_HEALTHY_SAMPLES.pdf",width = 16,height=12)
print(VlnPlot(new.skin.combined,group.by = "seurat_clusters",features = "nCount_Spatial",cols = custom_colors))
dev.off()

# LOG TRANSFORMED UMI COUNTS
pdf(file = "VIOLIN_PLOT_UMIs_and_CLUSTERS_HEALTHY_SAMPLES(LOG_TRANSFORMED).pdf",width = 16,height=12)
print(VlnPlot(new.skin.combined,group.by = "seurat_clusters",features = "nCount_Spatial",cols = custom_colors,log = TRUE))
dev.off()
```

```{r}
# SPOT FREQUENCY TABLE - BY SPATIAL REGION
spatial.freq <- as.data.frame(table(new.skin.combined@meta.data$Spatial.regions))
write.csv(spatial.freq,file="SPATIAL_REGIONS_CLUSTERS_SPOT_COUNTS.csv")
```

## QC FIGURES - Replotting
# Supplementary figure - 2
```{r}
# HEALTHY FEMALE SKIN 2
#REMOVE SPOTS
HEALTHY.Female1.s3 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HF-1/",slice="HealthyFemale-1-S3")

## HEALTHY FEMALE
HEALTHY.Female2.s1 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HF-2E/",slice="HealthyFemale-2-S1")
HEALTHY.Female2.s2 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HF-2F/",slice="HealthyFemale-2-S2")

#HEALATHY MALE
HEALTHY.Male.s2 <- Load10X_Spatial(data.dir ="../../SEVENTH RUN/ST-HM-1/",slice="HealthyMale-1-S2")
```
```{r}
remove.spots <- read.csv(file="../../CLOUPE_FILES/SEVENTH_RUN/HF-1-SP/remove.csv")
subset_spots <- Cells(HEALTHY.Female1.s3)[which((!(rownames(HEALTHY.Female1.s3@meta.data) %in% remove.spots$Barcode)))]
HEALTHY.Female1.s3.clean <- subset(HEALTHY.Female1.s3,cells=subset_spots)

pdf(width = 8,height=10,file = "HV2_SP_SPATIAL_PLOT(UNFILTERED).pdf")
print(SpatialDimPlot(HEALTHY.Female1.s3.clean,pt.size.factor = 2,group.by = "orig.ident"))
dev.off()

pdf(width = 8,height=10,file = "HV2_SP_SPATIAL_PLOT(FILTERED).pdf")
print(SpatialDimPlot(new.skin.combined,images = "HealthyFemale.1.S3",pt.size.factor = 2,group.by = "orig.ident"))
dev.off()
```

```{r}
remove.spots <- read.csv(file="../../CLOUPE_FILES/SEVENTH_RUN/HF-2-SE/Remove.csv")
subset_spots <- Cells(HEALTHY.Female2.s1)[which((!(rownames(HEALTHY.Female2.s1@meta.data) %in% remove.spots$Barcode)))]
HEALTHY.Female2.s1.clean <- subset(HEALTHY.Female2.s1,cells=subset_spots)

pdf(width = 8,height=10,file = "HV3_SE_SPATIAL_PLOT(UNFILTERED).pdf")
print(SpatialDimPlot(HEALTHY.Female2.s1.clean,pt.size.factor = 2,group.by = "orig.ident"))
dev.off()

pdf(width = 8,height=10,file = "HV3_SE_SPATIAL_PLOT(FILTERED).pdf")
print(SpatialDimPlot(new.skin.combined,images = "HealthyFemale.2.S1",pt.size.factor = 2,group.by = "orig.ident"))
dev.off()
```
```{r}
remove.spots <- read.csv(file="../../CLOUPE_FILES/SEVENTH_RUN/HF-2-SP/Remove.csv")
subset_spots <- Cells(HEALTHY.Female2.s2)[which((!(rownames(HEALTHY.Female2.s2@meta.data) %in% remove.spots$Barcode)))]
HEALTHY.Female2.s2.clean <- subset(HEALTHY.Female2.s2,cells=subset_spots)

pdf(width = 8,height=10,file = "HV3_SP_SPATIAL_PLOT(UNFILTERED).pdf")
print(SpatialDimPlot(HEALTHY.Female2.s2.clean,pt.size.factor = 2,group.by = "orig.ident"))
dev.off()

pdf(width = 8,height=10,file = "HV3_SP_SPATIAL_PLOT(FILTERED).pdf")
print(SpatialDimPlot(new.skin.combined,images = "HealthyFemale.2.S2",pt.size.factor = 2,group.by = "orig.ident"))
dev.off()
```

```{r}
remove.spots <- read.csv(file="../../CLOUPE_FILES/SEVENTH_RUN/HM-SP-2/remove.csv")
subset_spots <- Cells(HEALTHY.Male.s2)[which((!(rownames(HEALTHY.Male.s2@meta.data) %in% remove.spots$Barcode)))]
HEALTHY.Male.s2.clean <- subset(HEALTHY.Male.s2,cells=subset_spots)

pdf(width = 8,height=10,file = "HV1_SP_R2_SPATIAL_PLOT(UNFILTERED).pdf")
print(SpatialDimPlot(HEALTHY.Male.s2.clean,pt.size.factor = 2.2,group.by = "orig.ident"))
dev.off()

pdf(width = 8,height=10,file = "HV1_SP_R2_SPATIAL_PLOT(FILTERED).pdf")
print(SpatialDimPlot(new.skin.combined,images = "HealthyMale.1.S2",pt.size.factor = 2.2,group.by = "orig.ident"))
dev.off()

```
### Import the spots to be removed from loupe browser.
```{r}
remove.spots <- read.csv(file="../../FIFTH_RUN/SAMPLE D1/REMOVE.csv")
subset_spots <- Cells(HEALTHY.Female1.s2)[which((!(rownames(HEALTHY.Female1.s2@meta.data) %in% remove.spots$Barcode)))]
HEALTHY.Female1.s2.clean <- subset(HEALTHY.Female1.s2,cells=subset_spots)
```
```{r}
SpatialDimPlot(HEALTHY.Female.s2.clean)
SpatialDimPlot(HEALTHY.Female1.s2.clean)

pdf(width = 8,height=10,file = "HV2_SP_R2_SPATIAL_PLOT(UNFILTERED).pdf")
print(SpatialDimPlot(HEALTHY.Female1.s2.clean,pt.size.factor = 2.2,group.by = "orig.ident"))
dev.off()

pdf(width = 8,height=10,file = "HV2_SP_R2_SPATIAL_PLOT(FILTERED).pdf")
print(SpatialDimPlot(new.skin.combined,images = "HealthyFemale.1.S2",pt.size.factor = 2.2,group.by = "orig.ident"))
dev.off()
```

## AVERAGE GENE COUNTS
```{r}
Idents(new.skin.combined) <- "seurat_clusters"

clusters <- unique(new.skin.combined@meta.data$seurat_clusters) %>% as.vector()

for(x in clusters){
  avg_exp.cluster <- AverageExpression(new.skin.combined,slot = "counts",assay="Spatial") %>% as.data.frame() %>% dplyr::select(paste("Spatial.",x,sep = "")) %>% filter(x>0) %>% write.csv(file = paste("CLUSTER_",x,"_GENE_COUNTS.csv",sep = ""))
}
```

```{r}
avg_exp.all_clusters <- AverageExpression(new.skin.combined,slot = "counts",assay="Spatial") %>% as.data.frame()
write.csv(avg_exp.all_clusters,file="ALL_CLUSTERS_GENE_COUNTS.csv")

avg_exp.cluster_4 <- AverageExpression(new.skin.combined,slot = "counts",assay="Spatial") %>% as.data.frame() %>% dplyr::select("Spatial.4.Hypodermis") %>% filter(Spatial.4.Hypodermis>0)
write.csv(avg_exp.cluster_4,file="CLUSTER_4_GENE_COUNTS.csv")
avg_exp.cluster_2 <- AverageExpression(new.skin.combined,slot = "counts",assay="Spatial") %>% as.data.frame() %>% dplyr::select("Spatial.2.Dermis.adipose") %>% filter(Spatial.2.Dermis.adipose>0)
write.csv(avg_exp.cluster_2,file="CLUSTER_2_GENE_COUNTS.csv")
```

## HANNIFA DATA - NEW UMAP
```{r}
healthy_skin.sc_data <- FindNeighbors(healthy_skin.sc_data, dims = 1:40)
healthy_skin.sc_data <- FindClusters(healthy_skin.sc_data, verbose = FALSE,resolution = 1)
healthy_skin.sc_data <- RunUMAP(healthy_skin.sc_data, dims = 1:40)
```
```{r}
Idents(healthy_skin.sc_data) <- "final_clustering"
healthy_skin.sc_data <- subset(healthy_skin.sc_data,idents = c("nan"),invert=TRUE)
```

```{r}
pdf(width = 12,height=8,file = "UMAP_HANNIFA_DATA_HEALTHY_SAMPLES_ONLY.pdf")
DimPlot(healthy_skin.sc_data,pt.size = 3.5,raster=FALSE)
dev.off()
```

